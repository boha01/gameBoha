<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameBoh - منصة شات الألعاب</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --dark: #2d3436;
            --darker: #1e272e;
            --light: #f5f6fa;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --purple: #6c5ce7;
            --pink: #fd79a8;
            --blue: #0984e3;
            --gradient: linear-gradient(135deg, var(--purple), var(--blue));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s ease;
        }

        body {
            background-color: var(--darker);
            color: var(--light);
            direction: rtl;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* تصميم جديد للشريط العلوي */
        .navbar {
            background: var(--gradient);
            padding: 0.8rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background-color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid white;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .auth-buttons {
            display: flex;
            gap: 0.8rem;
        }

        /* تصميم جديد للقائمة الجانبية */
        .sidebar {
            width: 280px;
            background-color: var(--dark);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }

        .sidebar-header {
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .channel-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .channel-list li {
            padding: 0.8rem 1.2rem;
            cursor: pointer;
            margin: 0 0.5rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .channel-list li:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .channel-list li.active {
            background: var(--primary);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
        }

        .channel-list li i {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .online-users h4 {
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-item-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .user-item-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-item-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
            position: absolute;
            bottom: 0;
            left: 0;
            border: 2px solid var(--dark);
        }

        /* منطقة الدردشة محسنة */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: url('https://images.unsplash.com/photo-1542751371-adc38448a05e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') no-repeat center center;
            background-size: cover;
            position: relative;
        }

        .chat-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 39, 46, 0.85);
            z-index: 0;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-actions {
            display: flex;
            gap: 0.8rem;
        }

        .messages-container {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            position: relative;
            z-index: 1;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 80%;
            position: relative;
        }

        .message.current-user {
            align-self: flex-end;
        }

        .message.current-user .message-content {
            align-items: flex-end;
        }

        .message.current-user .message-text {
            background: var(--primary);
            border-radius: 18px 0 18px 18px;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .message-username {
            font-weight: bold;
            font-size: 0.95rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .message-text {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.8rem 1rem;
            border-radius: 0 18px 18px 18px;
            backdrop-filter: blur(5px);
            line-height: 1.5;
            position: relative;
        }

        .message-actions {
            position: absolute;
            top: 0;
            left: -30px;
            display: none;
            gap: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .message-action-btn:hover {
            background: var(--danger);
        }

        .message-img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 0.5rem;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-audio {
            width: 100%;
            margin-top: 0.5rem;
        }

        .message-input-container {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(5px);
        }

        .message-input {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }

        .message-input textarea {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1rem;
            color: var(--light);
            resize: none;
            height: 50px;
            max-height: 150px;
            backdrop-filter: blur(5px);
        }

        .message-input textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .input-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .input-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
        }

        .input-action-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        /* منطقة البث المباشر محسنة */
        .stream-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--darker);
            position: relative;
        }

        .stream-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        .stream-container {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .stream-container video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .stream-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 2;
        }

        .streamer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .streamer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .streamer-name {
            font-weight: bold;
        }

        .stream-viewers {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stream-chat {
            width: 350px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.3);
        }

        .stream-messages {
            flex: 1;
            padding: 1.2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .stream-input-container {
            padding: 0.8rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* تصميم جديد للأزرار */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-primary:hover {
            background: #5a4bd6;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #00a884;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }

        /* النماذج محسنة */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--dark);
            border-radius: 12px;
            width: 450px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.3rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.3);
        }

        .form-text {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.3rem;
        }

        .modal-footer {
            padding: 1.2rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
        }

        /* صفحة الإعدادات */
        .settings-page {
            padding: 2rem;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .settings-section h3 {
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--secondary);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-label {
            font-size: 0.95rem;
        }

        .settings-item-desc {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.3rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* تأثيرات جديدة */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(108, 92, 231, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(108, 92, 231, 0);
            }
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* التجاوب */
        @media (max-width: 992px) {
            .stream-chat {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }

            .stream-chat {
                width: 100%;
                height: 300px;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .message {
                max-width: 90%;
            }

            .message-img {
                max-width: 200px;
            }

            .navbar {
                padding: 0.8rem 1rem;
            }

            .nav-links {
                gap: 0.8rem;
            }

            .nav-links a span {
                display: none;
            }
        }

        @media (max-width: 576px) {
            .modal-content {
                width: 95%;
            }

            .btn span {
                display: none;
            }

            .btn i {
                margin: 0;
            }

            .message-actions {
                display: flex !important;
                position: static;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- شريط التنقل الجديد -->
        <nav class="navbar">
            <div class="logo">
                <i class="fas fa-gamepad"></i>
                <span>GameBoh</span>
            </div>
            <div class="nav-links">
                <a href="#" class="active" data-page="home"><i class="fas fa-home"></i> <span>الرئيسية</span></a>
                <a href="#" data-page="communities"><i class="fas fa-users"></i> <span>المجتمعات</span></a>
                <a href="#" data-page="streams"><i class="fas fa-video"></i> <span>البث المباشر</span></a>
                <a href="#" data-page="tournaments"><i class="fas fa-trophy"></i> <span>البطولات</span></a>
                <a href="#" data-page="settings"><i class="fas fa-cog"></i> <span>الإعدادات</span></a>
            </div>
            <div class="user-section">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="auth-buttons">
                    <button id="loginBtn" class="btn btn-outline"><i class="fas fa-sign-in-alt"></i> <span>تسجيل الدخول</span></button>
                    <button id="signupBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> <span>إنشاء حساب</span></button>
                </div>
            </div>
        </nav>

        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <!-- القائمة الجانبية -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-comments"></i> قنوات الدردشة</h3>
                    <button class="btn btn-icon btn-small" id="createChannelBtn"><i class="fas fa-plus"></i></button>
                </div>
                <ul class="channel-list" id="channelList">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </ul>

                <div class="sidebar-footer">
                    <div class="online-users">
                        <h4><i class="fas fa-users"></i> الأعضاء المتصلين (<span id="onlineCount">0</span>)</h4>
                        <div class="user-list" id="onlineUsers">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- منطقة الدردشة -->
            <div class="chat-area" id="chatArea">
                <div class="chat-header">
                    <h2><i class="fas fa-hashtag"></i> <span id="currentChannel">عام</span></h2>
                    <div class="chat-actions">
                        <button class="btn btn-small" id="startStreamBtn"><i class="fas fa-video"></i> <span>بث مباشر</span></button>
                        <button class="btn btn-small" id="shareScreenBtn"><i class="fas fa-desktop"></i> <span>مشاركة الشاشة</span></button>
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
                <div class="message-input-container">
                    <div class="input-actions">
                        <button class="input-action-btn" id="attachFileBtn"><i class="fas fa-paperclip"></i></button>
                        <button class="input-action-btn" id="recordAudioBtn"><i class="fas fa-microphone"></i></button>
                        <button class="input-action-btn" id="sendImageBtn"><i class="fas fa-image"></i></button>
                    </div>
                    <div class="message-input">
                        <textarea id="messageInput" placeholder="اكتب رسالة هنا..."></textarea>
                        <button id="sendMessageBtn" class="btn btn-primary btn-icon"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- منطقة البث المباشر -->
            <div class="stream-area hidden" id="streamArea">
                <div class="stream-header">
                    <h2><i class="fas fa-video"></i> البث المباشر</h2>
                    <button class="btn btn-small btn-danger" id="stopStreamBtn"><i class="fas fa-stop"></i> <span>إيقاف البث</span></button>
                </div>
                <div class="stream-container">
                    <video id="streamVideo" autoplay playsinline></video>
                    <div class="stream-info hidden" id="streamInfo">
                        <div class="streamer-avatar">
                            <img src="" alt="صورة الباث" id="streamerAvatar">
                        </div>
                        <div>
                            <div class="streamer-name" id="streamerName">...</div>
                            <div class="stream-viewers"><i class="fas fa-eye"></i> <span id="viewersCount">0</span> مشاهد</div>
                        </div>
                    </div>
                </div>
                <div class="stream-chat">
                    <div class="stream-messages" id="streamMessages">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                    </div>
                    <div class="stream-input-container">
                        <div class="message-input">
                            <textarea id="streamMessageInput" placeholder="اكتب تعليق..."></textarea>
                            <button id="sendStreamMessageBtn" class="btn btn-primary btn-icon"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- صفحة الإعدادات -->
            <div class="settings-page hidden" id="settingsPage">
                <div class="settings-section">
                    <h3><i class="fas fa-user-cog"></i> إعدادات الحساب</h3>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">تحديث الصورة الشخصية</div>
                            <div class="settings-item-desc">غير صورتك لجعل حسابك مميزاً</div>
                        </div>
                        <button class="btn btn-small">تغيير</button>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">تغيير اسم المستخدم</div>
                            <div class="settings-item-desc">اختر اسماً يميزك في المجتمع</div>
                        </div>
                        <button class="btn btn-small">تغيير</button>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">تغيير كلمة المرور</div>
                            <div class="settings-item-desc">حافظ على أمان حسابك</div>
                        </div>
                        <button class="btn btn-small">تغيير</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3><i class="fas fa-bell"></i> الإشعارات</h3>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">إشعارات الرسائل</div>
                            <div class="settings-item-desc">تلقي إشعارات عند وصول رسائل جديدة</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">إشعارات البث المباشر</div>
                            <div class="settings-item-desc">إشعارات عندما يبدأ أصدقاؤك بثاً مباشراً</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">إشعارات البطولات</div>
                            <div class="settings-item-desc">إشعارات حول البطولات القادمة</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3><i class="fas fa-shield-alt"></i> الخصوصية</h3>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">حساب خاص</div>
                            <div class="settings-item-desc">الموافقة على طلبات المتابعة قبل قبولها</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">إخفاء حالة الاتصال</div>
                            <div class="settings-item-desc">إخفاء ما إذا كنت متصلاً أم لا</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-item-label">منع الرسائل المباشرة</div>
                            <div class="settings-item-desc">السماح فقط للأصدقاء بإرسال رسائل مباشرة</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نماذج تسجيل الدخول والتسجيل -->
    <div class="modal hidden" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authModalTitle">تسجيل الدخول</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">البريد الإلكتروني</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="أدخل بريدك الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">كلمة المرور</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="أدخل كلمة المرور">
                        <p class="form-text"><a href="#" id="forgotPassword">نسيت كلمة المرور؟</a></p>
                    </div>
                    <div class="form-group">
                        <button id="submitLogin" class="btn btn-primary btn-block">تسجيل الدخول</button>
                    </div>
                    <div class="auth-toggle">
                        ليس لديك حساب؟ <a href="#" id="showSignup">إنشاء حساب</a>
                    </div>
                </div>

                <div class="auth-form hidden" id="signupForm">
                    <div class="form-group">
                        <label for="signupUsername">اسم المستخدم</label>
                        <input type="text" id="signupUsername" class="form-control" placeholder="اختر اسم مستخدم">
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">البريد الإلكتروني</label>
                        <input type="email" id="signupEmail" class="form-control" placeholder="أدخل بريدك الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">كلمة المرور</label>
                        <input type="password" id="signupPassword" class="form-control" placeholder="اختر كلمة مرور قوية">
                        <p class="form-text">يجب أن تحتوي على 8 أحرف على الأقل</p>
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword">تأكيد كلمة المرور</label>
                        <input type="password" id="signupConfirmPassword" class="form-control" placeholder="أعد كتابة كلمة المرور">
                    </div>
                    <div class="form-group">
                        <button id="submitSignup" class="btn btn-primary btn-block">إنشاء حساب</button>
                    </div>
                    <div class="auth-toggle">
                        لديك حساب بالفعل؟ <a href="#" id="showLogin">تسجيل الدخول</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إنشاء قناة جديدة -->
    <div class="modal hidden" id="channelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إنشاء قناة جديدة</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="channelName">اسم القناة</label>
                    <input type="text" id="channelName" class="form-control" placeholder="أدخل اسم القناة">
                </div>
                <div class="form-group">
                    <label for="channelDescription">وصف القناة</label>
                    <textarea id="channelDescription" class="form-control" placeholder="أدخل وصفاً للقناة"></textarea>
                </div>
                <div class="form-group">
                    <label for="channelType">نوع القناة</label>
                    <select id="channelType" class="form-control">
                        <option value="public">عامة (للجميع)</option>
                        <option value="private">خاصة (بكود الدخول)</option>
                    </select>
                </div>
                <div class="form-group hidden" id="channelPasswordGroup">
                    <label for="channelPassword">كود الدخول</label>
                    <input type="text" id="channelPassword" class="form-control" placeholder="أدخل كود الدخول">
                    <p class="form-text">سيحتاج الأعضاء إلى هذا الكود للانضمام</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelChannelBtn">إلغاء</button>
                <button class="btn btn-primary" id="createChannelSubmit">إنشاء القناة</button>
            </div>
        </div>
    </div>

    <!-- نموذج انضمام إلى قناة خاصة -->
    <div class="modal hidden" id="joinChannelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>انضمام إلى قناة خاصة</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="joinChannelCode">كود الدخول</label>
                    <input type="text" id="joinChannelCode" class="form-control" placeholder="أدخل كود الدخول">
                    <p class="form-text">يجب أن يكون لديك كود الدخول للانضمام إلى هذه القناة</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelJoinChannelBtn">إلغاء</button>
                <button class="btn btn-primary" id="joinChannelBtn">انضمام</button>
            </div>
        </div>
    </div>

    <!-- نموذج إرفاق ملف -->
    <div class="modal hidden" id="fileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="fileModalTitle">إرفاق ملف</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="fileInputLabel">اختر ملفاً للإرسال</label>
                    <input type="file" id="fileInput" class="form-control" accept="image/*, audio/*">
                </div>
                <div class="form-group hidden" id="filePreviewGroup">
                    <label>معاينة الملف</label>
                    <div id="filePreview"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelFileBtn">إلغاء</button>
                <button class="btn btn-primary" id="sendFileBtn">إرسال</button>
            </div>
        </div>
    </div>

    <!-- نموذج تسجيل صوتي -->
    <div class="modal hidden" id="audioModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تسجيل رسالة صوتية</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="text-align: center;">
                    <div id="audioVisualizer" style="width: 100%; height: 100px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 1rem;"></div>
                    <div id="audioTimer">00:00</div>
                    <div id="audioControls" style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-danger btn-icon" id="recordBtn"><i class="fas fa-microphone"></i></button>
                        <button class="btn btn-outline btn-icon" id="playBtn" disabled><i class="fas fa-play"></i></button>
                        <button class="btn btn-outline btn-icon" id="deleteBtn" disabled><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelAudioBtn">إلغاء</button>
                <button class="btn btn-primary" id="sendAudioBtn" disabled>إرسال</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-storage-compat.js"></script>
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAn8kbIMofOsk6IM6GYukwFPx5tIlJDA4w",
            authDomain: "for-boha.firebaseapp.com",
            projectId: "for-boha",
            storageBucket: "for-boha.appspot.com",
            messagingSenderId: "912434092147",
            appId: "1:912434092147:web:efe32b4603535c2608b206"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // متغيرات التطبيق
        let currentUser = null;
        let currentChannel = "general";
        let currentPage = "home";
        let stream = null;
        let screenStream = null;
        let peerConnections = {};
        let audioRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let audioContext = null;
        let analyser = null;
        let mediaRecorder = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let selectedFile = null;

        // عناصر DOM
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const authModal = document.getElementById("authModal");
        const loginForm = document.getElementById("loginForm");
        const signupForm = document.getElementById("signupForm");
        const showLogin = document.getElementById("showLogin");
        const showSignup = document.getElementById("showSignup");
        const submitLogin = document.getElementById("submitLogin");
        const submitSignup = document.getElementById("submitSignup");
        const forgotPassword = document.getElementById("forgotPassword");
        const userAvatar = document.getElementById("userAvatar");
        const channelList = document.getElementById("channelList");
        const messagesContainer = document.getElementById("messagesContainer");
        const messageInput = document.getElementById("messageInput");
        const sendMessageBtn = document.getElementById("sendMessageBtn");
        const createChannelBtn = document.getElementById("createChannelBtn");
        const channelModal = document.getElementById("channelModal");
        const channelType = document.getElementById("channelType");
        const channelPasswordGroup = document.getElementById("channelPasswordGroup");
        const createChannelSubmit = document.getElementById("createChannelSubmit");
        const cancelChannelBtn = document.getElementById("cancelChannelBtn");
        const onlineUsers = document.getElementById("onlineUsers");
        const onlineCount = document.getElementById("onlineCount");
        const currentChannelTitle = document.getElementById("currentChannel");
        const startStreamBtn = document.getElementById("startStreamBtn");
        const stopStreamBtn = document.getElementById("stopStreamBtn");
        const shareScreenBtn = document.getElementById("shareScreenBtn");
        const streamArea = document.getElementById("streamArea");
        const streamVideo = document.getElementById("streamVideo");
        const streamInfo = document.getElementById("streamInfo");
        const streamerAvatar = document.getElementById("streamerAvatar");
        const streamerName = document.getElementById("streamerName");
        const viewersCount = document.getElementById("viewersCount");
        const streamMessages = document.getElementById("streamMessages");
        const streamMessageInput = document.getElementById("streamMessageInput");
        const sendStreamMessageBtn = document.getElementById("sendStreamMessageBtn");
        const joinChannelModal = document.getElementById("joinChannelModal");
        const joinChannelBtn = document.getElementById("joinChannelBtn");
        const cancelJoinChannelBtn = document.getElementById("cancelJoinChannelBtn");
        const joinChannelCode = document.getElementById("joinChannelCode");
        const navLinks = document.querySelectorAll(".nav-links a");
        const chatArea = document.getElementById("chatArea");
        const settingsPage = document.getElementById("settingsPage");
        const sidebar = document.getElementById("sidebar");
        const attachFileBtn = document.getElementById("attachFileBtn");
        const recordAudioBtn = document.getElementById("recordAudioBtn");
        const sendImageBtn = document.getElementById("sendImageBtn");
        const fileModal = document.getElementById("fileModal");
        const fileInput = document.getElementById("fileInput");
        const filePreview = document.getElementById("filePreview");
        const sendFileBtn = document.getElementById("sendFileBtn");
        const cancelFileBtn = document.getElementById("cancelFileBtn");
        const audioModal = document.getElementById("audioModal");
        const recordBtn = document.getElementById("recordBtn");
        const playBtn = document.getElementById("playBtn");
        const deleteBtn = document.getElementById("deleteBtn");
        const sendAudioBtn = document.getElementById("sendAudioBtn");
        const cancelAudioBtn = document.getElementById("cancelAudioBtn");
        const audioTimer = document.getElementById("audioTimer");
        const audioVisualizer = document.getElementById("audioVisualizer");

        // استمع لتغير حالة المصادقة
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                updateUIForLoggedInUser(user);
                setupUserPresence(user);
                loadChannels();
                loadMessages(currentChannel);
                loadOnlineUsers();
            } else {
                currentUser = null;
                updateUIForLoggedOutUser();
            }
        });

        // تحديث واجهة المستخدم للمستخدم المسجل الدخول
        function updateUIForLoggedInUser(user) {
            document.querySelector(".auth-buttons").classList.add("hidden");
            userAvatar.innerHTML = user.photoURL 
                ? `<img src="${user.photoURL}" alt="صورة المستخدم">`
                : `<span>${user.displayName ? user.displayName.charAt(0) : user.email.charAt(0)}</span>`;
            userAvatar.style.backgroundColor = user.photoURL ? 'transparent' : stringToColor(user.uid);
            userAvatar.classList.add("user-avatar-loggedin");
            
            // تحميل صورة المستخدم إذا كانت موجودة
            if (user.photoURL) {
                userAvatar.innerHTML = `<img src="${user.photoURL}" alt="صورة المستخدم">`;
            }
        }

        // تحديث واجهة المستخدم للمستخدم غير المسجل الدخول
        function updateUIForLoggedOutUser() {
            document.querySelector(".auth-buttons").classList.remove("hidden");
            userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            userAvatar.classList.remove("user-avatar-loggedin");
            messagesContainer.innerHTML = "";
            channelList.innerHTML = "";
            onlineUsers.innerHTML = "";
        }

        // إعداد حضور المستخدم
        function setupUserPresence(user) {
            const userStatusRef = database.ref(`status/${user.uid}`);
            const userInfoRef = database.ref(`users/${user.uid}`);
            
            database.ref(".info/connected").on("value", snapshot => {
                if (snapshot.val() === false) return;
                
                userStatusRef.onDisconnect().set({
                    status: "offline",
                    lastChanged: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    userStatusRef.set({
                        status: "online",
                        lastChanged: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    userInfoRef.set({
                        displayName: user.displayName || user.email.split("@")[0],
                        email: user.email,
                        photoURL: user.photoURL || "",
                        uid: user.uid
                    });
                });
            });
        }

        // تحميل القنوات
        function loadChannels() {
            database.ref("channels").on("value", snapshot => {
                channelList.innerHTML = "";
                
                snapshot.forEach(channel => {
                    const channelData = channel.val();
                    const channelItem = document.createElement("li");
                    channelItem.innerHTML = `
                        <i class="fas ${channelData.type === 'private' ? 'fa-lock' : 'fa-hashtag'}"></i>
                        <span>${channelData.name}</span>
                    `;
                    channelItem.dataset.channelId = channel.key;
                    
                    if (channel.key === currentChannel) {
                        channelItem.classList.add("active");
                    }
                    
                    channelItem.addEventListener("click", () => {
                        if (channelData.type === 'private' && channelData.createdBy !== currentUser.uid) {
                            openJoinChannelModal(channel.key, channelData.name);
                        } else {
                            switchChannel(channel.key, channelData.name);
                        }
                    });
                    
                    channelList.appendChild(channelItem);
                });
            });
        }

        // فتح نموذج انضمام إلى قناة خاصة
        function openJoinChannelModal(channelId, channelName) {
            currentChannel = channelId;
            joinChannelModal.classList.remove("hidden");
        }

        // تبديل القناة
        function switchChannel(channelId, channelName) {
            currentChannel = channelId;
            currentChannelTitle.textContent = channelName;
            
            document.querySelectorAll("#channelList li").forEach(item => {
                item.classList.remove("active");
                if (item.dataset.channelId === channelId) {
                    item.classList.add("active");
                }
            });
            
            loadMessages(channelId);
        }

        // تحميل الرسائل
        function loadMessages(channelId) {
            messagesContainer.innerHTML = "";
            
            database.ref(`messages/${channelId}`).orderByChild("timestamp").limitToLast(100).on("value", snapshot => {
                messagesContainer.innerHTML = "";
                
                snapshot.forEach(message => {
                    const messageData = message.val();
                    displayMessage(messageData, message.key);
                });
                
                scrollToBottom(messagesContainer);
            });
        }

        // عرض الرسالة
        function displayMessage(messageData, messageId) {
            const isCurrentUser = currentUser && messageData.userId === currentUser.uid;
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");
            if (isCurrentUser) messageElement.classList.add("current-user");
            
            const avatarColor = stringToColor(messageData.userId);
            
            let content = '';
            if (messageData.type === 'image') {
                content = `<img src="${messageData.content}" class="message-img" onclick="openImageModal('${messageData.content}')">`;
            } else if (messageData.type === 'audio') {
                content = `
                    <audio controls class="message-audio">
                        <source src="${messageData.content}" type="audio/wav">
                        متصفحك لا يدعم تشغيل الصوتيات
                    </audio>
                `;
            } else {
                content = `<div class="message-text">${messageData.content}</div>`;
            }
            
            messageElement.innerHTML = `
                <div class="message-avatar" style="background-color: ${messageData.userPhoto ? 'transparent' : avatarColor}">
                    ${messageData.userPhoto 
                        ? `<img src="${messageData.userPhoto}" alt="صورة المستخدم">` 
                        : messageData.userName.charAt(0)}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username">${messageData.userName}</span>
                        <span class="message-time">${formatTime(messageData.timestamp)}</span>
                    </div>
                    ${content}
                </div>
                ${isCurrentUser ? `
                    <div class="message-actions">
                        <button class="message-action-btn" data-message-id="${messageId}" onclick="deleteMessage('${messageId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : ''}
            `;
            
            messagesContainer.appendChild(messageElement);
            scrollToBottom(messagesContainer);
        }

        // حذف الرسالة
        function deleteMessage(messageId) {
            if (!currentUser) return;
            
            if (confirm("هل أنت متأكد من حذف هذه الرسالة؟")) {
                database.ref(`messages/${currentChannel}/${messageId}`).remove()
                    .catch(error => {
                        alert("حدث خطأ أثناء حذف الرسالة: " + error.message);
                    });
            }
        }

        // إرسال رسالة
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUser) return;
            
            const messageRef = database.ref(`messages/${currentChannel}`).push();
            const userName = currentUser.displayName || currentUser.email.split("@")[0];
            
            messageRef.set({
                content: text,
                type: 'text',
                userId: currentUser.uid,
                userName: userName,
                userPhoto: currentUser.photoURL || "",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                messageInput.value = "";
            }).catch(error => {
                console.error("Error sending message:", error);
            });
        }

        // إرسال ملف
        function sendFile(file, type) {
            if (!currentUser || !file) return;
            
            const storageRef = storage.ref(`messages/${currentChannel}/${file.name}`);
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // تتبع التقدم
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                }, 
                (error) => {
                    console.error("Upload error:", error);
                    alert("حدث خطأ أثناء رفع الملف");
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const messageRef = database.ref(`messages/${currentChannel}`).push();
                        const userName = currentUser.displayName || currentUser.email.split("@")[0];
                        
                        messageRef.set({
                            content: downloadURL,
                            type: type,
                            userId: currentUser.uid,
                            userName: userName,
                            userPhoto: currentUser.photoURL || "",
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            fileName: file.name
                        });
                        
                        closeModal(fileModal);
                    });
                }
            );
        }

        // تحميل المستخدمين المتصلين
        function loadOnlineUsers() {
            database.ref("status").orderByChild("status").equalTo("online").on("value", snapshot => {
                onlineUsers.innerHTML = "";
                let count = 0;
                
                snapshot.forEach(user => {
                    if (user.key === currentUser?.uid) return;
                    
                    count++;
                    const userStatus = user.val();
                    
                    database.ref(`users/${user.key}`).once("value", userSnapshot => {
                        const userData = userSnapshot.val();
                        if (!userData) return;
                        
                        const userItem = document.createElement("div");
                        userItem.classList.add("user-item");
                        userItem.dataset.userId = userData.uid;
                        
                        const avatarColor = stringToColor(userData.uid);
                        
                        userItem.innerHTML = `
                            <div class="user-item-avatar" style="background-color: ${userData.photoURL ? 'transparent' : avatarColor}">
                                ${userData.photoURL 
                                    ? `<img src="${userData.photoURL}" alt="صورة المستخدم">` 
                                    : userData.displayName?.charAt(0) || userData.email?.charAt(0) || "U"}
                                <div class="user-item-status"></div>
                            </div>
                            <span>${userData.displayName || userData.email}</span>
                        `;
                        
                        userItem.addEventListener("click", () => {
                            startPrivateChat(userData);
                        });
                        
                        onlineUsers.appendChild(userItem);
                    });
                });
                
                onlineCount.textContent = count;
            });
        }

        // بدء دردشة خاصة
        function startPrivateChat(userData) {
            // إنشاء قناة خاصة بين المستخدمين
            const channelId = [currentUser.uid, userData.uid].sort().join('_');
            const channelRef = database.ref(`privateChannels/${channelId}`);
            
            channelRef.once("value").then(snapshot => {
                if (!snapshot.exists()) {
                    channelRef.set({
                        userIds: [currentUser.uid, userData.uid],
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // تحميل الرسائل الخاصة
                loadPrivateMessages(channelId, userData.displayName || userData.email);
            });
        }

        // إنشاء قناة جديدة
        function createChannel() {
            const name = document.getElementById("channelName").value.trim();
            const description = document.getElementById("channelDescription").value.trim();
            const type = document.getElementById("channelType").value;
            const password = type === 'private' ? document.getElementById("channelPassword").value.trim() : null;
            
            if (!name) {
                alert("يرجى إدخال اسم القناة");
                return;
            }
            
            if (type === 'private' && !password) {
                alert("يرجى إدخال كود الدخول للقناة الخاصة");
                return;
            }
            
            const channelRef = database.ref("channels").push();
            channelRef.set({
                name: name,
                description: description,
                type: type,
                password: password,
                createdBy: currentUser.uid,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                closeModal(channelModal);
                document.getElementById("channelName").value = "";
                document.getElementById("channelDescription").value = "";
                if (type === 'private') {
                    document.getElementById("channelPassword").value = "";
                }
            }).catch(error => {
                console.error("Error creating channel:", error);
            });
        }

        // بدء البث المباشر
        async function startStream() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                streamVideo.srcObject = stream;
                
                document.querySelector(".chat-area").classList.add("hidden");
                streamArea.classList.remove("hidden");
                
                const streamRef = database.ref(`streams/${currentUser.uid}`);
                await streamRef.set({
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email.split("@")[0],
                    userPhoto: currentUser.photoURL || "",
                    startedAt: firebase.database.ServerValue.TIMESTAMP,
                    channelId: currentChannel,
                    viewers: 0
                });
                
                // تحديث عدد المشاهدين
                database.ref(`streams/${currentUser.uid}/viewers`).on("value", snapshot => {
                    viewersCount.textContent = snapshot.val() || 0;
                });
                
                setupWebRTC();
                
            } catch (error) {
                console.error("Error starting stream:", error);
                alert("حدث خطأ أثناء بدء البث. يرجى التأكد من صلاحيات الكاميرا والميكروفون.");
            }
        }

        // إيقاف البث المباشر
        function stopStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                streamVideo.srcObject = null;
                
                streamArea.classList.add("hidden");
                document.querySelector(".chat-area").classList.remove("hidden");
                
                database.ref(`streams/${currentUser.uid}`).remove();
                
                Object.values(peerConnections).forEach(pc => pc.close());
                peerConnections = {};
            }
        }

        // مشاركة الشاشة
        async function shareScreen() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { displaySurface: 'monitor' },
                    audio: true 
                });
                
                document.querySelector(".chat-area").classList.add("hidden");
                streamArea.classList.remove("hidden");
                streamVideo.srcObject = screenStream;
                
                screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                    stopStream();
                });
                
                const screenShareRef = database.ref(`screenShares/${currentUser.uid}`);
                await screenShareRef.set({
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email.split("@")[0],
                    userPhoto: currentUser.photoURL || "",
                    startedAt: firebase.database.ServerValue.TIMESTAMP,
                    channelId: currentChannel
                });
                
            } catch (error) {
                console.error("Error sharing screen:", error);
            }
        }

        // تبديل الصفحات
        function switchPage(page) {
            currentPage = page;
            
            // إخفاء جميع الصفحات
            document.querySelectorAll('.main-content > *').forEach(el => {
                el.classList.add('hidden');
            });
            
            // إظهار الصفحة المطلوبة
            if (page === 'home') {
                sidebar.classList.remove('hidden');
                chatArea.classList.remove('hidden');
            } else if (page === 'settings') {
                settingsPage.classList.remove('hidden');
            } else if (page === 'streams') {
                // يمكنك إضافة صفحة البث المباشر هنا
                sidebar.classList.remove('hidden');
                chatArea.classList.remove('hidden');
            } else {
                sidebar.classList.remove('hidden');
                chatArea.classList.remove('hidden');
            }
            
            // تحديث التنقل النشط
            navLinks.forEach(link => {
                if (link.dataset.page === page) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // بدء تسجيل الصوت
        async function startRecording() {
            try {
                audioChunks = [];
                recordingSeconds = 0;
                audioTimer.textContent = "00:00";
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                // إعداد AudioContext للتصوير البصري
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                // بدء التصوير البصري
                visualizeAudio();
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    playBtn.disabled = false;
                    deleteBtn.disabled = false;
                    sendAudioBtn.disabled = false;
                    
                    // إيقاف AudioContext
                    if (audioContext) {
                        await audioContext.close();
                        audioContext = null;
                    }
                };
                
                mediaRecorder.start();
                recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                recordBtn.classList.remove('btn-danger');
                recordBtn.classList.add('btn-success');
                
                // بدء العد التنازلي
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
                    const seconds = (recordingSeconds % 60).toString().padStart(2, '0');
                    audioTimer.textContent = `${minutes}:${seconds}`;
                }, 1000);
                
            } catch (error) {
                console.error("Error recording audio:", error);
                alert("حدث خطأ أثناء تسجيل الصوت. يرجى التأكد من صلاحيات الميكروفون.");
            }
        }

        // إيقاف تسجيل الصوت
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingTimer);
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                recordBtn.classList.remove('btn-success');
                recordBtn.classList.add('btn-danger');
            }
        }

        // تشغيل الصوت المسجل
        function playRecording() {
            if (!audioBlob) return;
            
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.play();
        }

        // تصوير بصري للصوت
        function visualizeAudio() {
            if (!analyser) return;
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const canvas = document.createElement('canvas');
            canvas.width = audioVisualizer.clientWidth;
            canvas.height = audioVisualizer.clientHeight;
            audioVisualizer.innerHTML = '';
            audioVisualizer.appendChild(canvas);
            
            const canvasCtx = canvas.getContext('2d');
            
            function draw() {
                if (!analyser) return;
                
                requestAnimationFrame(draw);
                
                analyser.getByteFrequencyData(dataArray);
                
                canvasCtx.fillStyle = 'rgb(0, 0, 0)';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / bufferLength) * 2.5;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2;
                    
                    canvasCtx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }
            
            draw();
        }

        // إرسال الصوت المسجل
        function sendAudioRecording() {
            if (!audioBlob || !currentUser) return;
            
            const audioFile = new File([audioBlob], `recording_${Date.now()}.wav`, { type: 'audio/wav' });
            sendFile(audioFile, 'audio');
            closeModal(audioModal);
        }

        // عرض معاينة الملف
        function previewFile(file) {
            filePreview.innerHTML = '';
            filePreview.classList.remove('hidden');
            document.getElementById('filePreviewGroup').classList.remove('hidden');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    filePreview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith('audio/')) {
                filePreview.innerHTML = `
                    <audio controls style="width: 100%; margin-top: 10px;">
                        <source src="${URL.createObjectURL(file)}" type="${file.type}">
                        متصفحك لا يدعم معاينة الصوت
                    </audio>
                `;
            } else {
                filePreview.innerHTML = `
                    <div style="padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <i class="fas fa-file" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <div>${file.name}</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                `;
            }
        }

        // وظائف مساعدة
        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        function formatTime(timestamp) {
            if (!timestamp) return "";
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = `hsl(${hash % 360}, 70%, 60%)`;
            return color;
        }

        function openModal(modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '2000';
            modal.style.cursor = 'pointer';
            
            modal.innerHTML = `
                <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;">
                <button style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG') return;
                document.body.removeChild(modal);
            });
            
            document.body.appendChild(modal);
        }

        // معالجات الأحداث
        loginBtn.addEventListener("click", () => {
            openModal(authModal);
            loginForm.classList.remove("hidden");
            signupForm.classList.add("hidden");
            document.getElementById("authModalTitle").textContent = "تسجيل الدخول";
        });

        signupBtn.addEventListener("click", () => {
            openModal(authModal);
            loginForm.classList.add("hidden");
            signupForm.classList.remove("hidden");
            document.getElementById("authModalTitle").textContent = "إنشاء حساب";
        });

        showLogin.addEventListener("click", e => {
            e.preventDefault();
            loginForm.classList.remove("hidden");
            signupForm.classList.add("hidden");
            document.getElementById("authModalTitle").textContent = "تسجيل الدخول";
        });

        showSignup.addEventListener("click", e => {
            e.preventDefault();
            loginForm.classList.add("hidden");
            signupForm.classList.remove("hidden");
            document.getElementById("authModalTitle").textContent = "إنشاء حساب";
        });

        forgotPassword.addEventListener("click", e => {
            e.preventDefault();
            const email = prompt("أدخل بريدك الإلكتروني لإعادة تعيين كلمة المرور:");
            if (email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => alert("تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني"))
                    .catch(error => alert("حدث خطأ: " + error.message));
            }
        });

        document.querySelectorAll(".close-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                const modal = this.closest(".modal");
                closeModal(modal);
            });
        });

        submitLogin.addEventListener("click", () => {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    closeModal(authModal);
                })
                .catch(error => {
                    alert("خطأ في تسجيل الدخول: " + error.message);
                });
        });

        submitSignup.addEventListener("click", () => {
            const email = document.getElementById("signupEmail").value;
            const password = document.getElementById("signupPassword").value;
            const confirmPassword = document.getElementById("signupConfirmPassword").value;
            const username = document.getElementById("signupUsername").value;
            
            if (password !== confirmPassword) {
                alert("كلمة المرور غير متطابقة");
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    return userCredential.user.updateProfile({
                        displayName: username
                    });
                })
                .then(() => {
                    closeModal(authModal);
                })
                .catch(error => {
                    alert("خطأ في إنشاء الحساب: " + error.message);
                });
        });

        sendMessageBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        createChannelBtn.addEventListener("click", () => {
            if (!currentUser) {
                alert("يجب تسجيل الدخول أولاً");
                return;
            }
            openModal(channelModal);
        });

        channelType.addEventListener("change", function() {
            if (this.value === 'private') {
                channelPasswordGroup.classList.remove('hidden');
            } else {
                channelPasswordGroup.classList.add('hidden');
            }
        });

        createChannelSubmit.addEventListener("click", createChannel);
        cancelChannelBtn.addEventListener("click", () => closeModal(channelModal));

        startStreamBtn.addEventListener("click", startStream);
        stopStreamBtn.addEventListener("click", stopStream);
        shareScreenBtn.addEventListener("click", shareScreen);

        sendStreamMessageBtn.addEventListener("click", () => {
            const text = streamMessageInput.value.trim();
            if (!text || !currentUser) return;
            
            const messageRef = database.ref(`streamMessages/${currentUser.uid}`).push();
            const userName = currentUser.displayName || currentUser.email.split("@")[0];
            
            messageRef.set({
                text: text,
                userId: currentUser.uid,
                userName: userName,
                userPhoto: currentUser.photoURL || "",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                streamMessageInput.value = "";
            });
        });

        streamMessageInput.addEventListener("keypress", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendStreamMessageBtn.click();
            }
        });

        joinChannelBtn.addEventListener("click", function() {
            const code = joinChannelCode.value.trim();
            if (!code) {
                alert("يرجى إدخال كود الدخول");
                return;
            }
            
            database.ref(`channels/${currentChannel}`).once("value").then(snapshot => {
                const channelData = snapshot.val();
                if (channelData.password === code) {
                    closeModal(joinChannelModal);
                    switchChannel(currentChannel, channelData.name);
                } else {
                    alert("كود الدخول غير صحيح");
                }
            });
        });

        cancelJoinChannelBtn.addEventListener("click", () => closeModal(joinChannelModal));

        // التنقل بين الصفحات
        navLinks.forEach(link => {
            link.addEventListener("click", function(e) {
                e.preventDefault();
                const page = this.dataset.page;
                switchPage(page);
            });
        });

        // إرفاق ملف
        attachFileBtn.addEventListener("click", function() {
            if (!currentUser) {
                alert("يجب تسجيل الدخول أولاً");
                return;
            }
            
            fileInput.value = '';
            filePreview.innerHTML = '';
            document.getElementById('filePreviewGroup').classList.add('hidden');
            document.getElementById('fileModalTitle').textContent = 'إرفاق ملف';
            fileInput.accept = '*';
            openModal(fileModal);
        });

        // إرسال صورة
        sendImageBtn.addEventListener("click", function() {
            if (!currentUser) {
                alert("يجب تسجيل الدخول أولاً");
                return;
            }
            
            fileInput.value = '';
            filePreview.innerHTML = '';
            document.getElementById('filePreviewGroup').classList.add('hidden');
            document.getElementById('fileModalTitle').textContent = 'إرسال صورة';
            fileInput.accept = 'image/*';
            openModal(fileModal);
        });

        // تسجيل صوتي
        recordAudioBtn.addEventListener("click", function() {
            if (!currentUser) {
                alert("يجب تسجيل الدخول أولاً");
                return;
            }
            
            audioChunks = [];
            audioBlob = null;
            playBtn.disabled = true;
            deleteBtn.disabled = true;
            sendAudioBtn.disabled = true;
            audioVisualizer.innerHTML = '';
            audioTimer.textContent = '00:00';
            
            openModal(audioModal);
        });

        fileInput.addEventListener("change", function() {
            if (this.files.length > 0) {
                selectedFile = this.files[0];
                previewFile(selectedFile);
            }
        });

        sendFileBtn.addEventListener("click", function() {
            if (selectedFile) {
                let type = 'file';
                if (selectedFile.type.startsWith('image/')) type = 'image';
                if (selectedFile.type.startsWith('audio/')) type = 'audio';
                
                sendFile(selectedFile, type);
            }
        });

        cancelFileBtn.addEventListener("click", () => closeModal(fileModal));

        recordBtn.addEventListener("click", function() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        });

        playBtn.addEventListener("click", playRecording);
        
        deleteBtn.addEventListener("click", function() {
            audioChunks = [];
            audioBlob = null;
            playBtn.disabled = true;
            deleteBtn.disabled = true;
            sendAudioBtn.disabled = true;
            audioTimer.textContent = '00:00';
            audioVisualizer.innerHTML = '';
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
        });

        sendAudioBtn.addEventListener("click", sendAudioRecording);
        cancelAudioBtn.addEventListener("click", () => closeModal(audioModal));

        // تحميل القناة العامة عند البدء
        window.addEventListener("load", () => {
            // التأكد من وجود القناة العامة
            database.ref("channels/general").once("value", snapshot => {
                if (!snapshot.exists()) {
                    database.ref("channels/general").set({
                        name: "عام",
                        description: "القناة العامة للجميع",
                        type: "public",
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
            
            // تعيين الصفحة الرئيسية كصفحة افتراضية
            switchPage('home');
        });

        // جعل الدالة متاحة عالمياً لحذف الرسائل
        window.deleteMessage = deleteMessage;
        window.openImageModal = openImageModal;
    </script>
</body>
</html>